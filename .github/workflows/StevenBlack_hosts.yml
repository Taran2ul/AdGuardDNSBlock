name: Weekly download and process StevenBlack hosts file

on:
  schedule:
    - cron: '0 0 * * 0'   # каждое воскресенье в 00:00 UTC
  workflow_dispatch:       # запуск вручную

jobs:
  process:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout target repo
        uses: actions/checkout@v3

      - name: Download hosts file
        run: |
          curl -L --fail https://raw.githubusercontent.com/StevenBlack/hosts/master/alternates/fakenews-gambling-porn/hosts -o hostsSB.raw

      - name: Clean hosts file (remove comments, empty lines, and system entries)
        run: |
          sed '/^\s*#/d; s/[[:space:]]#.*$//; /^\s*$/d' hostsSB.raw \
          | grep -v -E '^(127\.0\.0\.1[[:space:]]+(localhost|localhost\.localdomain|local))$' \
          | grep -v -E '^(255\.255\.255\.255[[:space:]]+broadcasthost)$' \
          | grep -v -E '^(::1[[:space:]]+(localhost|ip6-localhost|ip6-loopback))$' \
          | grep -v -E '^(fe80::1%lo0[[:space:]]+localhost)$' \
          | grep -v -E '^(ff00::0[[:space:]]+(ip6-localnet|ip6-mcastprefix))$' \
          | grep -v -E '^(ff02::1[[:space:]]+ip6-allnodes)$' \
          | grep -v -E '^(ff02::2[[:space:]]+ip6-allrouters)$' \
          | grep -v -E '^(ff02::3[[:space:]]+ip6-allhosts)$' \
          | grep -v -E '^(0\.0\.0\.0[[:space:]]+0\.0\.0\.0)$' \
          > hostsSB.cleaned

      - name: Transform hosts file to AdGuard format
        run: |
          awk 'NF==2 {print "||"$2"^$dnsrewrite="$1}' hostsSB.cleaned > hostsalx

      - name: Check for changes
        run: |
          if git diff --quiet -- hostsalx; then
            echo "No changes in processed hosts file"
            exit 0
          fi

      - name: Commit and push updated hosts file
        run: |
          git config user.name "github-actions"
          git config user.email "actions@github.com"
          git add hostsalx
          git diff --cached --quiet || git commit -m "Weekly AdGuard DNS rewrite StevenBlack hosts update"
          git push

      - name: Cleanup temporary files
        run: |
          rm -f hostsSB.raw hostsSB.cleaned
